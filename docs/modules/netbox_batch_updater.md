# NetboxBatchUpdater

## Описание

`NetboxBatchUpdater` — это модуль для пакетного обновления описаний интерфейсов в NetBox. Он предназначен для оптимизации процесса обновления большого количества интерфейсов, минимизируя количество HTTP-запросов к API NetBox. 

Основные преимущества:
- **Пакетные обновления**: Использует bulk-PATCH для обновления нескольких интерфейсов за один запрос (NetBox 3.3+).
- **Кэширование**: Загружает все интерфейсы устройства одним запросом и кэширует их.
- **Нормализация имён**: Автоматически обрабатывает варианты имён интерфейсов (например, `Po1` → `Port-channel1`) с помощью `InterfaceNormalizer`.
- **Очередь изменений**: Собирает обновления в памяти, без немедленных запросов к API.
- **Статистика**: Собирает метрики (обновлено, пропущено, неизменено и т.д.) для анализа.

Модуль интегрируется с существующим `netbox_connector` из `custom_modules` и использует готовое соединение `NetboxDevice.netbox_connection`.

Это решение значительно ускоряет работу с большими объёмами данных, снижая количество запросов на порядки (с тысяч до десятков).

## Использование

Модуль используется как контекст-менеджер. Основные методы:
- `queue(device_name, if_name, new_descr)`: Добавляет обновление в очередь.
- `flush()`: Отправляет накопленные изменения пакетами в NetBox.

### Основной пример

```python
from custom_modules.netbox_batch_updater import NetboxBatchUpdater
from custom_modules.log import logger

# Инициализация (batch_size — размер пакета для bulk-PATCH)
with NetboxBatchUpdater(batch_size=400, overwrite_existing=False) as updater:
    # Добавляем обновления в очередь
    updater.queue(device_name="switch-01", if_name="GigabitEthernet1/0/1", new_descr="Host: 192.168.1.10 (MAC: aa:bb:cc:dd:ee:ff)")
    updater.queue(device_name="switch-02", if_name="Port-channel1", new_descr="Connected to server-02")

    # Отправляем все изменения (или автоматически в __exit__)
    updater.flush()

# Вывод статистики
logger.info(f"Обновления NetBox: {updater.stats}")
```

### Параметры инициализации
- `batch_size` (int, по умолчанию 400): Максимальное количество интерфейсов в одном bulk-PATCH запросе. Рекомендуется ≤1000 для стабильности NetBox.
- `overwrite_existing` (bool, по умолчанию False): Если True, перезаписывает существующие описания; если False, пропускает интерфейсы с непустыми описаниями.

### Метрики (stats)
После `flush()` доступен словарь `updater.stats` с ключами:
- `updated`: Количество успешно обновлённых интерфейсов.
- `skipped`: Пропущено из-за существующих описаний (если `overwrite_existing=False`).
- `unchanged`: Описания не изменились.
- `not_found`: Интерфейс не найден (с нормализацией).
- `failed`: Не удалось обновить (ошибки API).

## Обработка ошибок
- Ошибки в bulk-PATCH логируются, но не прерывают процесс (метрика `failed` увеличивается).
- Если устройство или интерфейс не найдены, обновление пропускается с соответствующей метрикой.
